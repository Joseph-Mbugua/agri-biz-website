<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register/Login</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Register/Login</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="register.html">Register</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="cart.html"><i class="fas fa-shopping-cart"></i> Cart <span id="cart-count">0</span></a></li>
        <li><a href="#" id="manage-account-link" style="display: none;" onclick="showManageAccount()">Manage Account</a></li>
        <li><a href="#" id="logout-link" style="display: none;" onclick="logout()">Logout</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <div id="form-container">
      <form id="register-form" onsubmit="register(event)">
        <h2>Register</h2>
        <label for="register-username">Username</label>
        <input type="text" id="register-username" required><br>

        <label for="register-email">Email</label>
        <input type="email" id="register-email" required><br>

        <label for="register-password">Password</label>
        <input type="password" id="register-password" required><br>

        <button type="submit" id="signup">Register</button>
        <button type="button" onclick="showLogin()">Switch to Login</button>
      </form>

      <form id="login-form" onsubmit="login(event)" style="display: none;">
        <h2>Login</h2>
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required><br>

        <label for="login-password">Password</label>
        <input type="password" id="login-password" required><br>

        <button type="submit" id="signin">Login</button>
        <button type="button" onclick="showRegister()">Switch to Register</button>
      </form>

      <form id="manage-account-form" style="display: none;">
        <h2>Manage Account</h2>
        <label for="manage-username">Username</label>
        <input type="text" id="manage-username" readonly><br>

        <label for="manage-email">Email</label>
        <input type="email" id="manage-email" readonly><br>

        <label for="manage-password">New Password</label>
        <input type="password" id="manage-password"><br>

        <button type="button" onclick="updatePassword()">Update Password</button>
        <button type="button" onclick="deleteAccount()">Delete Account</button>
        <button type="button" onclick="showLogin()">Back to Login</button>
      </form>
    </div>
  </main>
  <footer class="footer">
    <hr />
    <br>
    <p><span>Developed by Joseph Mbugua &copy; 2024. All rights reserved.</span></p>
  </footer>

  <!-- Import Firebase and scripts -->
  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <!-- Add additional Firebase products that you want to use -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"></script>

  <!-- Your custom JavaScript files -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword as updatePasswordFirebase, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlCMR9NQgWg2r1I1xPZ2AZ6lk-yoZDOOg",
      authDomain: "agriculture-ecomm.firebaseapp.com",
      databaseURL: "https://agriculture-ecomm-default-rtdb.firebaseio.com",
      projectId: "agriculture-ecomm",
      storageBucket: "agriculture-ecomm.appspot.com",
      messagingSenderId: "1081774247089",
      appId: "1:1081774247089:web:6c57438b3bae218bcf2690",
      measurementId: "G-3EJRGTGY4V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const analytics = getAnalytics(app);

    // Check if user is logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('manage-account-link').style.display = 'block';
        document.getElementById('logout-link').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('manage-account-form').style.display = 'none';
        // Load user data
        loadUserData(user);
      } else {
        document.getElementById('manage-account-link').style.display = 'none';
        document.getElementById('logout-link').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('manage-account-form').style.display = 'none';
      }
    });

    function showRegister() {
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('manage-account-form').style.display = 'none';
    }

    function showLogin() {
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('manage-account-form').style.display = 'none';
    }

    function showManageAccount() {
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('manage-account-form').style.display = 'block';
      loadUserData(auth.currentUser);
    }

    function loadUserData(user) {
      const userDocRef = doc(db, 'users', user.uid);
      getDoc(userDocRef)
        .then((doc) => {
          if (doc.exists()) {
            const userData = doc.data();
            document.getElementById('manage-username').value = userData.username;
            document.getElementById('manage-email').value = userData.email;
          } else {
            console.log('No such document!');
          }
        })
        .catch((error) => {
          console.error('Error getting document:', error);
        });
    }

    function updatePassword() {
      const newPassword = document.getElementById('manage-password').value;
      const user = auth.currentUser;

      updatePasswordFirebase(user, newPassword)
        .then(() => {
          alert('Password updated successfully!');
          document.getElementById('manage-password').value = '';
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          alert(errorMessage);
        });
    }

    function deleteAccount() {
      const user = auth.currentUser;

      deleteUser(user)
        .then(() => {
          alert('Account deleted successfully!');
          window.location.href = "index.html"; // Redirect to home page or login page
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          alert(errorMessage);
        });
    }

    function logout() {
      auth.signOut().then(() => {
        // Sign-out successful.
        alert('Logged out successfully!');
        window.location.href = "index.html"; // Redirect to home page or login page
      }).catch((error) => {
        // An error happened.
        console.log(error.message);
      });
    }

    // Make the showRegister, showLogin, showManageAccount functions globally accessible
    window.showRegister = showRegister;
    window.showLogin = showLogin;
    window.showManageAccount = showManageAccount;
  </script>
</body>
</html>
